#include "wasm2c_wrapper.h"
#include <wasm-rt.h>
#include "module.h"  // Generated by wasm2c
#include <stdlib.h>
#include <stdio.h>

// Provide a weak implementation of os_print_last_error if not provided by runtime
__attribute__((weak))
void os_print_last_error(const char* msg) {
    perror(msg);
}

Wasm2cEngine* wasm2c_engine_new(void) {
    Wasm2cEngine* engine = calloc(1, sizeof(Wasm2cEngine));
    if (!engine) return NULL;

    // Initialize WASM runtime
    wasm_rt_init();

    // Allocate and initialize the module instance
    engine->instance = calloc(1, sizeof(struct w2c_module));
    if (!engine->instance) {
        free(engine);
        return NULL;
    }

    // Initialize the generated wasm2c module
    wasm2c_module_instantiate(engine->instance);

    return engine;
}

void wasm2c_engine_delete(Wasm2cEngine* engine) {
    if (!engine) return;
    if (engine->instance) {
        wasm2c_module_free(engine->instance);
        free(engine->instance);
    }
    wasm_rt_free();
    free(engine);
}

float wasm2c_engine_get_sample(Wasm2cEngine* engine, float input) {
    if (!engine || !engine->instance) {
        printf("ERROR: wasm2c engine or instance is NULL!\n");
        return 0.0f;
    }

    // Call the generated wasm2c function
    // The signature is: f32 w2c_module_get_sample(struct w2c_module*, f32)
    float result = w2c_module_get_sample(engine->instance, input);
    
    return result;
}
