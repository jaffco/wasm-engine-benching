#include "wasm2c_wrapper.h"
#include <wasm-rt.h>
#include "module.h"  // Generated by wasm2c
#include <stdlib.h>
#include <stdio.h>
#include <string.h>  // For memcpy

// Provide a weak implementation of os_print_last_error if not provided by runtime
__attribute__((weak))
void os_print_last_error(const char* msg) {
    perror(msg);
}

Wasm2cEngine* wasm2c_engine_new(void) {
    Wasm2cEngine* engine = calloc(1, sizeof(Wasm2cEngine));
    if (!engine) return NULL;

    // Initialize WASM runtime
    wasm_rt_init();

    // Allocate and initialize the module instance
    engine->instance = calloc(1, sizeof(struct w2c_module));
    if (!engine->instance) {
        free(engine);
        return NULL;
    }

    // Initialize the generated wasm2c module
    wasm2c_module_instantiate(engine->instance);

    return engine;
}

void wasm2c_engine_delete(Wasm2cEngine* engine) {
    if (!engine) return;
    if (engine->instance) {
        wasm2c_module_free(engine->instance);
        free(engine->instance);
    }
    wasm_rt_free();
    free(engine);
}

void wasm2c_engine_process(Wasm2cEngine* engine, float* input, float* output, int num_samples) {
    if (!engine || !engine->instance) {
        printf("ERROR: wasm2c engine or instance is NULL!\n");
        return;
    }

    // Get WASM memory pointer and size
    uint32_t mem_size = engine->instance->w2c_memory.size;
    uint8_t* mem_data = engine->instance->w2c_memory.data;
    
    // Allocate space in WASM memory for input and output buffers
    // Using simple offset-based allocation (should be sufficient for this use case)
    uint32_t input_offset = 0;
    uint32_t output_offset = num_samples * sizeof(float);
    
    // Check if we have enough memory
    if ((output_offset + num_samples * sizeof(float)) > mem_size) {
        printf("ERROR: Not enough WASM memory\n");
        return;
    }
    
    // Copy input buffer to WASM memory
    memcpy(mem_data + input_offset, input, num_samples * sizeof(float));
    
    // Call the generated wasm2c process function
    // The signature is: void w2c_module_process(struct w2c_module*, u32 input_ptr, u32 output_ptr, u32 num_samples)
    w2c_module_process(engine->instance, input_offset, output_offset, num_samples);
    
    // Copy output buffer from WASM memory
    memcpy(output, mem_data + output_offset, num_samples * sizeof(float));
}
